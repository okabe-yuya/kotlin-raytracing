/*
 * This source file was generated by the Gradle 'init' task
 */
package org.example

import org.example.Vec3
import org.example.Color
import org.example.Ray
import kotlin.math.sqrt

fun hitSphere(center: Point3, radius: Double, r: Ray): Double {
    val oc: Vec3 = center - r.origin
    val a = r.direction.dot(r.direction)
    val b = -2.0 * (r.direction.dot(oc))
    val c = oc.dot(oc) - radius * radius
    val discriminant = b * b - (a * c) * 4.0

    if (discriminant < 0) {
        return -1.0
    } else {
        return (-b - sqrt(discriminant)) / (2.0 * a) 
    }
}

fun rayColor(r: Ray): Color {
    val t = hitSphere(Point3(0.0, 0.0, -1.0), 0.5, r)
    if (t > 0.0) {
        val N = unitVector(r.at(t) - Vec3(0.0, 0.0, -1.0))
        return 0.5 * Color(N.x + 1, N.y + 1, N.z + 1)
    }

    val unitDirection: Vec3 = unitVector(r.direction)
    val a = 0.5 * (unitDirection.y + 1.0)
    return (1.0 - a) * Color(1.0, 1.0, 1.0) + a * Color(0.5, 0.7, 1.0)
}

fun main() {
    // Image
    val aspectRation = 16.0 / 9.0
    val imageWidth: Int = 400
    var imageHeight: Int = (imageWidth / aspectRation).toInt()
    imageHeight = if (imageHeight < 1) {
        1
    } else {
        imageHeight
    }

    // Camera
    val focalLength = 1.0
    val viewportHeight = 2.0
    val viewportWidth = viewportHeight * (imageWidth.toDouble() / imageHeight)
    val cameraCenter = Point3(0.0, 0.0, 0.0)

    // Calculate the vectors across the horizontal and down the vertical viewport edges.
    val viewportU = Vec3(viewportWidth, 0.0, 0.0)
    val viewportV = Vec3(0.0, -viewportHeight, 0.0)

    // Calculate the horizontal and vertical delta vectors from pixel to pixel.
    val pixelDeltaU = viewportU / imageWidth.toDouble()
    val pixelDeltaV = viewportV / imageHeight.toDouble()

    // Calculate the location of the upper left pixel.
    val viewportUpperLeft = cameraCenter - Vec3(0.0, 0.0, focalLength) - viewportU / 2.0 - viewportV / 2.0
    val pixel00Loc = viewportUpperLeft + 0.5 * (pixelDeltaU + pixelDeltaV)
    
    // Render
    print("P3\n${imageWidth} ${imageHeight}\n255\n") 

    for  (j in 0..(imageHeight - 1)) {
        for  (i in 0..(imageWidth - 1)) {
            System.err.println("\rScanlines remaining: ${imageHeight - j} ")
            System.err.flush()

            val pixelCenter = pixel00Loc + (i.toDouble() * pixelDeltaU) + (j.toDouble() * pixelDeltaV)
            val rayDirection = pixelCenter - cameraCenter
            val r = Ray(cameraCenter, rayDirection)

            val pixelColor = rayColor(r) 
            writeColor(pixelColor)

        }
    }

    System.err.println("\rDone.            \n")
}

